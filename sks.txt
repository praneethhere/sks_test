###

$ACTION="$env:Action"
$GROUPS="$env:Groups"
$SERVERS="$env:Servers"
$SITESCOPEUSR="$env:SiteScopeUser"
$SITESCOPEPSW="$env:SiteScopePassword"

$APIDIR='C:\SiteScopeAPIExamples\bin'
$SITESCOPESRV="10.127.198.131"
$SITESCOPEPORT="8080"

Write-Host "$ACTION -> $GROUPS -> $SERVERS"

if ( Test-Path $APIDIR ) {
    Set-Location -Path $APIDIR
    
    if ( $ACTION -eq 'disable' ) {
        $ACTIONCMDGRP='disable_group'
        $ACTIONCMDSRV='disable_monitor'
    } else {
        $ACTIONCMDGRP='enable_group'
        $ACTIONCMDSRV='enable_monitor'
    }
    
    if ($GROUPS) {
        $GROUPS=$GROUPS.replace(' ','').split(',')
        foreach($GROUP in $GROUPS) {
           Write-Host "$ACTIONCMDGRP for Group $GROUP"
            try {

                Set-Location -Path $APIDIR
                $searchGroupObjPath = (cmd /c "search.bat" -host $SITESCOPESRV -port $SITESCOPEPORT -useSSL false -login $SITESCOPEUSR -password $SITESCOPEPSW -searchText $GROUP -groupsOnly true | findstr "\/$GROUP" | Select-Object -Last 1).Trim().split('|')[0])
                if ($searchGroupObjPath) {
                    cmd /c "$ACTIONCMDGRP.bat"  -host $SITESCOPESRV -port $SITESCOPEPORT -useSSL false -login $SITESCOPEUSR -password $SITESCOPEPSW -groupPath $searchGroupObjPath
                } else { 
                    write-host "Disable monitor failed for group: $GROUP as unable to find respective monitor group path"
                }

            } catch {
                write-host "Failed with error: $_"
            }
        }
    }

    if ($SERVERS) {
        $SERVERS=$SERVERS.replace(' ','').split(',')
        foreach($SERVER in $SERVERS){
            Write-Host "$ACTIONCMDSRV for Server $SERVER"
            try {

                Set-Location -Path $APIDIR
                $searchServerObjPath = (cmd /c "search.bat" -hosts 10.127.198.131 -ports 8080 -useSSL false -logins olbapiid -passwords password -searchText $SERVER -monitorsOnly true | findstr "\/$SERVER" | Select-Object -Last 1).Trim().split('|')[0])
                if ($searchServerObjPath){
                    cmd /c "$ACTIONCMDSRV.bat"  -host $SITESCOPESRV -port $SITESCOPEPORT -useSSL false -login $SITESCOPEUSR -password $SITESCOPEPSW -monitorPath $searchServerObjPath
                else {
                    write-host "Disable monitor failed for server: $SERVER as unable to find respective monitor server path"                

                }
            } catch {
                write-host "Failed with error: $_"
            }
        }
    }

} else {
   write-host "Not present $APIDIR"
}
    

## END ##     
