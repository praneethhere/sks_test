IMG_CentOS7 = "centos/7"
IMG_CentOS6 = "centos/6"
IPRANGE='192.168.8.11' # your VirtualBox network 
DISK='12GB'
CPU=1
RAM=512
VMS = ["ansible-101:IMG_CentOS7:10GB:2:512", "test-101:IMG_CentOS7", "test-201:IMG_CentOS6"]
COUNT = VMS.length - 1

Vagrant.configure("2") do |config|

    (0..COUNT).each do |cnt|
        
        VMINFO = VMS[cnt].split(':')
        config.vm.define VMINFO[0] do |vc|
            VMINFO = VMS[cnt].split(':')
            VMIMG  = eval(VMINFO[1])
            VMNAME = VMINFO[0]
            if VMIMG.nil?
                VMIMG = IMG_CentOS7
            end
            # Image 
            vc.vm.box = VMIMG
            
            vc.vm.provider "virtualbox" do |vb|
                VMINFO = VMS[cnt].split(':')
                VMNAME = VMINFO[0]
                VMDISK = VMINFO[2]
                VMCPU  = VMINFO[3]
                VMRAM  = VMINFO[4]
                if VMDISK.nil?
                    VMDISK = DISK
                end 
                if VMCPU.nil?
                    VMCPU = CPU
                end 
                if VMRAM.nil?
                    VMRAM = RAM
                end
                vb.name          = VMNAME
                #vb.disksize.size = VMDISK # no need this require separate plugin ..
                vb.cpus          = VMCPU
                vb.memory        = VMRAM
            end
            
            ## Setup
            IP = "#{IPRANGE}#{cnt + 1}"
            vc.vm.network :private_network, ip: "#{IP}"
            if VMIMG.include? '7'
                vc.vm.hostname = VMNAME
            end
            
            ## Execute Shell Command # node default vagrant all run as sudo by vagrant user so no need of sudo 
            vc.vm.provision "shell", inline: <<-SHELL
            
                # set hostname if rhel6
                if [[ "#{VMIMG}" =~ 6 ]]; then
                    if grep ^HOSTNAME /etc/sysconfig/network; then
                        sed -i "s/HOSTNAME=.*/HOSTNAME=#{VMNAME}/g" /etc/sysconfig/network
                    else
                        echo -e HOSTNAME="#{VMNAME}" >> /etc/sysconfig/network
                    fi 
                fi 
                hostname "#{VMNAME}"
                
                #yum clean all
                SSHD='/etc/ssh/sshd_config'
                # permit password auth 
                if grep ^PasswordAuthentication $SSHD; then
                    sed -i 's/PasswordAuthentication.*/PasswordAuthentication yes/g' $SSHD
                else
                    echo 'PasswordAuthentication yes' >>  $SSHD 
                fi
                # permit root login 
                if grep ^PermitRootLogin $SSHD; then
                    sed -i 's/PermitRootLogin.*/PermitRootLogin yes/g' $SSHD
                else
                    echo 'PermitRootLogin yes' >> $SSHD # enable password login
                fi
                service sshd restart
                # set root passwd
                echo 'x' | passwd root --stdin                                                             # set root password 
                useradd -m -p 'xx' -s /bin/bash 'sks'                                                      # add user sks 
                echo 'sks   ALL=(ALL)    NOPASSWD:ALL' > /etc/sudoers.d/sks                                # full to user
                
                # Install pkgs 
                [[ "#{VMNAME}" =~ 'ansible' ]] && PKG='ansible' && echo Install $PKG
                echo "yum -y install vim bind-utils net-tools epel-release sysstat $PKG"                  # Install PKGS 
                yum -y install vim bind-utils net-tools epel-release sysstat wget $PKG                
            SHELL
        end
    end
end

## END 
